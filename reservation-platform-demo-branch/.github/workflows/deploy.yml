name: Deploy to NCP

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
    - name: Download frontend build
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push backend
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/michelin-backend:latest
        cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/michelin-backend:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/michelin-backend:buildcache,mode=max

    - name: Build and push frontend
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/michelin-frontend:latest
        cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/michelin-frontend:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/michelin-frontend:buildcache,mode=max

    - name: Deploy to NCP
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.NCP_HOST }}
        username: ${{ secrets.NCP_USERNAME }}
        key: ${{ secrets.NCP_SSH_KEY }}
        script: |
          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë°±ì—…
          cp .env .env.backup

          # ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/michelin-backend:latest
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/michelin-frontend:latest

          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
          docker-compose down || true

          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
          docker-compose up -d

          # í—¬ìŠ¤ ì²´í¬
          echo "Waiting for services to be healthy..."
          sleep 30

          # í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
          if ! curl -f http://localhost:8000/health; then
            echo "Health check failed, rolling back..."
            docker-compose down
            mv .env.backup .env
            docker-compose up -d
            exit 1
          fi

          # ì„±ê³µ ì‹œ ë°±ì—… íŒŒì¼ ì‚­ì œ
          rm .env.backup

    - name: Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
        text: |
          ğŸš€ **NCP ë°°í¬ ì•Œë¦¼**
          â€¢ ì›Œí¬í”Œë¡œìš°: ${{ github.workflow }}
          â€¢ ë¸Œëœì¹˜: ${{ github.ref_name }}
          â€¢ ì»¤ë°‹: ${{ github.sha }}
          â€¢ ìƒíƒœ: ${{ job.status }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      continue-on-error: true